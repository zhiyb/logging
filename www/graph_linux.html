<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/boo_vector_art.svg">
<script>
// https://stackoverflow.com/a/5448595
function findGetParameter(parameterName) {
    var result = null,
        tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
    }
    return result;
}
var hn = findGetParameter('h');
if (!hn)
  hn = "zhiyb-vps";
</script>
<script>document.write(`<title>Logging graphs - ${hn}</title>`);</script>
</head>
<body>
<h1><script>document.write(hn);</script></h1>
<div id="test"></div>
<h2>CPU</h2>
<div id="graph_cpu"></div>
<h2>Memory</h2>
<div id="graph_mem"></div>
<h2>Network IO</h2>
<div id="graph_netio"></div>
<h2>Temperature</h2>
<div id="graph_temp"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script type="module">
import {add_chart, parse_ts} from "./functions.js";

let linkedZoom = [];
let url = "get.php?h=" + hn + "&t=";

$.getJSON(url + "cpu", data => {
  if (!data.length)
    return;

  let values = [];
  let maxcpu = 0;
  for (let obj of data) {
    if (obj.id > maxcpu)
      maxcpu = obj.id;

    let ts = obj.idle === null ? NaN : parse_ts(obj.ts);

    values.push({
      ts: ts,
      type: "cpu" + obj.id,
      val: 100 - obj.idle,
    });
  }

  add_chart($('#graph_cpu'), values, {
    x: d => d.ts,
    y: d => d.val,
    z: d => d.type,
    yLabel: "↑ %",
    yDomain: [0, 100],
    width: 1024,
    height: 500,
    //curve: d3.curveMonotoneX,
    mixBlendMode: "normal",
    linkedZoom: linkedZoom,
  });
});

$.getJSON(url + "mem", data => {
  if (!data.length)
    return;

  let values = [];
  let total = 0;
  for (let obj of data) {
    let ts = NaN;
    if (obj.total !== null) {
      ts = parse_ts(obj.ts);
      total = obj.total / 1024 / 1024 / 1024;
    }

    values.push({
      ts: ts,
      type: "used",
      val: (obj.total - obj.buffers - obj.cached - obj.zfs_arc - obj.free) / 1024 / 1024 / 1024,
    });
    // "total", "available", "percent", "used", "free", "active", "inactive", "buffers", "cached", "shared", "slab"
    for (let key of ["buffers", "cached", "zfs_arc", "free"]) {
      values.push({
        ts: ts,
        type: key,
        val: obj[key] / 1024 / 1024 / 1024,
      });
    }
  }

  add_chart($('#graph_mem'), values, {
    x: d => d.ts,
    y: d => d.val,
    z: d => d.type,
    stacked: true,
    yLabel: "↑ GiB",
    yDomain: [0, total],
    width: 1024,
    height: 500,
    linkedZoom: linkedZoom,
  });
});

$.getJSON(url + "netio", data => {
  if (!data.length)
    return;

  let values = [];
  for (let obj of data) {
    let ts = obj.interval === null ? NaN : parse_ts(obj.ts);
    values.push({
      ts: ts,
      type: obj.nic + "_tx",
      val: obj.interval === null ? NaN : obj.bytes_sent * 8 / obj.interval / 1024 / 1024,
    });
    values.push({
      ts: ts,
      type: obj.nic + "_rx",
      val: obj.interval === null ? NaN : obj.bytes_recv * 8 / obj.interval / 1024 / 1024,
    });
  }

  add_chart($('#graph_netio'), values, {
    x: d => d.ts,
    y: d => d.val,
    z: d => d.type,
    yLabel: "↑ Mbps",
    width: 1024,
    height: 500,
    //curve: d3.curveMonotoneX,
    mixBlendMode: "normal",
    linkedZoom: linkedZoom,
  });
});

$.getJSON(url + "temp", data => {
  if (!data.length)
    return;

  let values = [];
  for (let obj of data) {
    let ts = obj.temp === null ? NaN : parse_ts(obj.ts);
    values.push({
      ts: ts,
      type: obj.label !== "" ? obj.label : obj.sensor,
      val: obj.temp,
    });
  }

  add_chart($('#graph_temp'), values, {
    x: d => d.ts,
    y: d => d.val,
    z: d => d.type,
    yLabel: "↑ ℃",
    width: 1024,
    height: 500,
    //curve: d3.curveMonotoneX,
    mixBlendMode: "normal",
    linkedZoom: linkedZoom,
  });
});

</script>
</body>
</html>

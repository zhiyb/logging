<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/boo_vector_art.svg">
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js" charset="utf-8"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>
// https://stackoverflow.com/a/5448595
function findGetParameter(parameterName) {
    var result = null,
        tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
    }
    return result;
}
var hn = findGetParameter('h');
if (!hn)
  hn = "zhiyb-vps";
</script>
<script>document.write(`<title>Logging graphs - ${hn}</title>`);</script>
</head>
<body>
<h1><script>document.write(hn);</script></h1>
<div id="graph"></div>

<script type="module">
import * as cmn from "./functions.js";

let url = "get.php?h=" + hn + "&t=";
let ajaxs = [];
let values = {};

// CPU usage data
ajaxs.push($.getJSON(url + "cpu", data => {
  if (!data.length)
    return;

  values.cpu = {};
  function add_new_key(key) {
    if (values.cpu[key] != undefined)
      return;
    values.cpu[key] = {
        name: key,
        legendrank: 1,
        legendgroup: "cpu",
        legendgrouptitle: {text: "- cpu -"},
        yaxis: "y5",
        type: "scattergl",
        mode: "lines",
        line: {"width": 1},
        x: [], y: [],
    };
  }

  for (let obj of data) {
    let ts = cmn.parse_ts(obj.ts);
    let key = "cpu" + obj.id;
    add_new_key(key);
    values.cpu[key].x.push(ts);
    values.cpu[key].y.push(obj.idle === null ? NaN : 100 - obj.idle);
  }
}));

// Memory usage data
ajaxs.push($.getJSON(url + "mem", data => {
  if (!data.length)
    return;

  values.mem = {};
  for (let key of ["used", "buffers", "cached", "zfs_arc", "free"]) {
    values.mem[key] = {
        name: key,
        legendrank: 2,
        legendgroup: "mem",
        legendgrouptitle: {text: "- mem -"},
        stackgroup: "mem",
        yaxis: "y4",
        //type: "scattergl",
        line: {"width": 1},
        x: [], y: [],
    };
  }

  let total = 0;
  for (let obj of data) {
    let ts = cmn.parse_ts(obj.ts);
    total = obj.total / 1024 / 1024 / 1024;

    let key = "used";
    values.mem[key].x.push(ts);
    values.mem[key].y.push(obj.total === null ? NaN :
      (obj.total - obj.buffers - obj.cached - obj.zfs_arc - obj.free) / 1024 / 1024 / 1024);

    for (let key of ["buffers", "cached", "zfs_arc", "free"]) {
      values.mem[key].x.push(ts);
      values.mem[key].y.push(obj.total === null ? NaN :
        obj[key] / 1024 / 1024 / 1024);
    }
  }
}));

// Network IO usage data
ajaxs.push($.getJSON(url + "netio", data => {
  if (!data.length)
    return;

  // Remove all zero series
  let vmap = new Set();
  for (const obj of data)
    if (obj.bytes_sent || obj.bytes_recv)
      vmap.add(obj.nic);
  if (!vmap.size)
    return;

  values.netio = {};
  function add_new_key(key) {
    if (values.netio[key] != undefined)
      return;
    values.netio[key] = {
        name: key,
        legendrank: 3,
        legendgroup: "netio",
        legendgrouptitle: {text: "- netio -"},
        yaxis: "y3",
        type: "scattergl",
        mode: "lines",
        line: {"width": 1},
        x: [], y: [],
    };
  }

  for (let obj of data) {
    if (!vmap.has(obj.nic))
      continue;
    let ts = cmn.parse_ts(obj.ts);

    let key = obj.nic + "_tx";
    add_new_key(key);
    values.netio[key].x.push(ts);
    values.netio[key].y.push(obj.interval === null ? NaN :
      obj.bytes_sent * 8 / obj.interval / 1024 / 1024);

    key = obj.nic + "_rx";
    add_new_key(key);
    values.netio[key].x.push(ts);
    values.netio[key].y.push(obj.interval === null ? NaN :
      obj.bytes_recv * 8 / obj.interval / 1024 / 1024);
  }
}));

// Disk IO usage data
ajaxs.push($.getJSON(url + "disk", data => {
  if (!data.length)
    return;

  // Remove all zero series
  let vmap = new Set();
  for (const obj of data)
    if (obj.write_bytes || obj.read_bytes)
      vmap.add(obj.disk);
  if (!vmap.size)
    return;

  values.disk = {};
  function add_new_key(key) {
    if (values.disk[key] != undefined)
      return;
    values.disk[key] = {
        name: key,
        legendrank: 4,
        legendgroup: "disk",
        legendgrouptitle: {text: "- disk -"},
        yaxis: "y2",
        type: "scattergl",
        mode: "lines",
        line: {"width": 1},
        x: [], y: [],
    };
  }

  for (let obj of data) {
    if (!vmap.has(obj.disk))
      continue;
    if (obj.disk.startsWith("dm-") || obj.disk.startsWith("loop"))
      continue;
    let ts = cmn.parse_ts(obj.ts);

    let key = obj.disk + "_wr";
    add_new_key(key);
    values.disk[key].x.push(ts);
    values.disk[key].y.push(obj.interval === null ? NaN :
      obj.write_bytes / obj.interval / 1024 / 1024);

    key = obj.disk + "_rd";
    add_new_key(key);
    values.disk[key].x.push(ts);
    values.disk[key].y.push(obj.interval === null ? NaN :
      obj.read_bytes / obj.interval / 1024 / 1024);
  }
}));

// Temperature data
ajaxs.push($.getJSON(url + "temp", data => {
  if (!data.length)
    return;

  values.temp = {};
  function add_new_key(key) {
    if (values.temp[key] != undefined)
      return;
    values.temp[key] = {
        name: key,
        legendrank: 5,
        legendgroup: "temp",
        legendgrouptitle: {text: "- temp -"},
        yaxis: "y",
        type: "scattergl",
        mode: "lines",
        line: {"width": 1},
        x: [], y: [],
    };
  }

  for (let obj of data) {
    let ts = cmn.parse_ts(obj.ts);
    let key = obj.label !== "" ? obj.label : obj.sensor;
    add_new_key(key);
    values.temp[key].x.push(ts);
    values.temp[key].y.push(obj.temp === null ? NaN : obj.temp);
  }
}));



// Plot after all ajax completed
$.when(...ajaxs).done(function () {
  let traces = [];
  for (let kv in values)
    for (let k in values[kv])
      traces.push(values[kv][k]);

  var layout = {
    autosize: true,
    height: 1800,
    margin: {
      t: 20,
      b: 80,
      l: 60,
      r: 20,
    },
    showlegend: true,
    legend: {
      orientation: "h",
      //yanchor: "bottom",
      //y: 1,
      groupclick: "toggleitem",
    },
    yaxis:  {domain: [0,   0.2], title: "temp (â„ƒ)"},
    yaxis2: {domain: [0.2, 0.4], title: "disk (MB/s)"},
    yaxis3: {domain: [0.4, 0.6], title: "netio (Mbps)"},
    yaxis4: {domain: [0.6, 0.8], title: "mem (GiB)"},
    yaxis5: {domain: [0.8, 1],   title: "cpu (%)"},
  };

  Plotly.react('graph', traces, layout, {responsive: true});
});

</script>
</body>
</html>
